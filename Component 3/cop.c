#include <stdio.h>
#include <stdlib.h>
#include <fcntl.h>
#include <unistd.h>
#include <sys/stat.h>
#include <string.h>
#include <stdbool.h>
#include <time.h>

#define DEFAULT_BUFFER_SIZE 1024

void copy_file(const char *src, const char *dest, int buffer_size, bool verbose, bool append, bool overwrite, bool copy_if_newer, size_t limit_size) {
    int src_fd, dest_fd, n_read;
    char buffer[buffer_size];
    struct stat src_stat, dest_stat;
    bool dest_exists = false;

    src_fd = open(src, O_RDONLY);
    if(src_fd < 0) exit(1);

    if(stat(src, &src_stat) < 0) exit(1);

    if(stat(dest, &dest_stat) == 0) {
        dest_exists = true;
        if(overwrite == false) {
            printf("Destination file exists. Overwrite? (y/n): ");
            char ch;
            scanf(" %c", &ch);
            if(ch != 'y' && ch != 'Y') exit(0);
        }
        if(copy_if_newer && src_stat.st_mtime <= dest_stat.st_mtime) {
            if(verbose) printf("Source is not newer than destination. Skipping copy.\n");
            exit(0);
        }
    }

    int flags = O_WRONLY | O_CREAT;
    if(append) flags |= O_APPEND; else if(!dest_exists || overwrite) flags |= O_TRUNC;

    dest_fd = open(dest, flags, 0666);
    if(dest_fd < 0) exit(1);

    size_t total_copied = 0;
    while((n_read = read(src_fd, buffer, buffer_size)) > 0 && (limit_size == 0 || total_copied < limit_size)) {
        size_t to_write = (limit_size != 0 && total_copied + n_read > limit_size) ? limit_size - total_copied : n_read;
        write(dest_fd, buffer, to_write);
        total_copied += to_write;
        if(verbose) printf("Copied %lu bytes\n", total_copied);
    }

    close(src_fd);
    close(dest_fd);
    if(verbose) printf("File copy completed.\n");
}

int main(int argc, char *argv[]) {
    if(argc < 3) {
        fprintf(stderr, "Usage: %s source_file destination_file [options]\n", argv[0]);
        exit(EXIT_FAILURE);
    }

    int buffer_size = DEFAULT_BUFFER_SIZE;
    bool verbose = false;
    bool append = false;
    bool overwrite = true;
    bool copy_if_newer = false;
    size_t limit_size = 0;

    for(int i = 3; i < argc; i++) {
        if(strcmp(argv[i], "--verbose") == 0 || strcmp(argv[i], "-v") == 0) {
            verbose = true;
        } else if(strcmp(argv[i], "--append") == 0 || strcmp(argv[i], "-a") == 0) {
            append = true;
        } else if(strcmp(argv[i], "--no-overwrite") == 0 || strcmp(argv[i], "-n") == 0) {
            overwrite = false;
        } else if(strcmp(argv[i], "--if-newer") == 0 || strcmp(argv[i], "-i") == 0) {
            copy_if_newer = true;
        } else if(strncmp(argv[i], "--buffer=", 9) == 0) {
            buffer_size = atoi(argv[i] + 9);
        } else if(strncmp(argv[i], "--limit=", 8) == 0) {
            limit_size = atol(argv[i] + 8);
        } else {
            fprintf(stderr, "Unknown option: %s\n", argv[i]);
            exit(EXIT_FAILURE);
        }
    }

    copy_file(argv[1], argv[2], buffer_size, verbose, append, overwrite, copy_if_newer, limit_size);

    return EXIT_SUCCESS;
}
